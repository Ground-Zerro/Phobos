#!/bin/sh
set -eu
IFS="
	"

PHOBOS_DIR="/opt/etc/Phobos"
OBFUSCATOR_CONFIG="${PHOBOS_DIR}/wg-obfuscator.conf"

print_status() {
  local status="$1"
  local message="$2"

  if [ "${status}" = "OK" ]; then
    printf "\\033[0;32m✓\\033[0m %s\n" "${message}"
  elif [ "${status}" = "WARN" ]; then
    printf "\\033[1;33m⚠\\033[0m %s\n" "${message}"
  else
    printf "\\033[0;31m✗\\033[0m %s\n" "${message}"
  fi
}

check_obfuscator_process() {
  if ps | grep -v grep | grep -q wg-obfuscator; then
    local pid=$(ps | grep -v grep | grep wg-obfuscator | awk '{print $1}' | head -1)
    print_status "OK" "wg-obfuscator запущен (PID: ${pid})"
    return 0
  else
    print_status "FAIL" "wg-obfuscator не запущен"
    return 1
  fi
}

check_obfuscator_listening() {
  if netstat -uln 2>/dev/null | grep -q ":8123\|:8124\|:8125"; then
    local port=$(netstat -uln 2>/dev/null | grep -E "(:8123|:8124|:8125)" | head -1 | awk '{print $4}' | sed 's/.*://')
    print_status "OK" "UDP порт ${port} доступен (предполагаем obfuscator)"
    return 0
  else
    if netstat -uln 2>/dev/null | tail -n +3 | grep -v "Active Internet connections" | grep -q "^udp"; then
      local port=$(netstat -uln 2>/dev/null | tail -n +3 | grep -v "Active Internet connections" | grep "^udp" | head -1 | awk '{print $4}' | sed 's/.*://')
      print_status "OK" "UDP порт ${port} доступен (предполагаем obfuscator)"
      return 0
    else
      print_status "FAIL" "UDP порты не слушаются (обфускатор может быть не запущен)"
      return 1
    fi
  fi
}

check_wireguard_keenetic() {
  if ! command -v jq >/dev/null 2>&1; then
    print_status "WARN" "jq не установлен, пропускаем проверку WireGuard"
    return 1
  fi

  local interfaces=$(curl -s "http://127.0.0.1:79/rci/show/interface" 2>/dev/null || echo "")

  if [ -z "$interfaces" ] || ! echo "$interfaces" | jq -e . >/dev/null 2>&1; then
    print_status "WARN" "Не удалось получить список интерфейсов через RCI API"
    return 1
  fi

  local wg_count=$(echo "$interfaces" | jq '[.[] | select(.type == "Wireguard")] | length' 2>/dev/null || echo "0")

  if [ ${wg_count} -gt 0 ]; then
    print_status "OK" "WireGuard интерфейсов в Keenetic: ${wg_count}"

    echo "  └─ Детали интерфейсов:"

    echo "$interfaces" | jq -r '.[] | select(.type == "Wireguard") | "\(.id)|\(.description // "no description")|\(.state)"' 2>/dev/null | while IFS='|' read -r if_id if_desc if_state; do
      printf "    %s: %s - %s" "$if_id" "$if_desc" "$if_state"

      if [ "$if_state" = "up" ]; then
        local sys_if=$(echo "$if_id" | sed 's/Wireguard/nwg/')

        if [ -n "$sys_if" ]; then
          local external_ip=$(curl --max-time 5 --interface "$sys_if" -s https://api.ipify.org 2>/dev/null || echo "")

          if [ -n "$external_ip" ]; then
            printf " (IP: %s)" "$external_ip"
          else
            printf " (IP: недоступен)"
          fi
        fi
      fi

      printf "\n"
    done

    return 0
  else
    print_status "WARN" "WireGuard интерфейсы не найдены в Keenetic"
    return 1
  fi
}

check_config_files() {
  # Look for WireGuard configuration files (excluding wg-obfuscator.conf)
  local wg_config_count=$(find "${PHOBOS_DIR}" -maxdepth 1 -name "*.conf" -not -name "wg-obfuscator.conf" 2>/dev/null | wc -l)
  
  if [ "${wg_config_count}" -gt 0 ]; then
    print_status "OK" "Конфигурации WireGuard найдены (${wg_config_count} файлов)"
    # List the WireGuard config files found
    find "${PHOBOS_DIR}" -maxdepth 1 -name "*.conf" -not -name "wg-obfuscator.conf" 2>/dev/null | head -3 | while read -r file; do
      echo "    └─ $(basename "${file}")"
    done
  else
    print_status "FAIL" "Конфигурации WireGuard не найдены"
  fi

  if [ -f "${OBFUSCATOR_CONFIG}" ]; then
    print_status "OK" "Конфигурация obfuscator найдена"
  else
    print_status "FAIL" "Конфигурация obfuscator не найдена: ${OBFUSCATOR_CONFIG}"
  fi
}

check_init_script() {
  if [ -f "/opt/etc/init.d/S49wg-obfuscator" ]; then
    print_status "OK" "Init скрипт obfuscator найден"
  else
    print_status "FAIL" "Init скрипт obfuscator не найден"
  fi
}

check_dns_resolution() {
  if nslookup google.com >/dev/null 2>&1; then
    if ping -c 1 -W 3 8.8.8.8 >/dev/null 2>&1; then
      print_status "OK" "DNS и интернет доступны"
      return 0
    else
      print_status "WARN" "DNS работает, но доступ к интернету ограничен"
      return 0
    fi
  else
    print_status "FAIL" "DNS не работает"
    return 1
  fi
}

check_internet_via_tunnel() {
  local server_ip=$(grep "target = " "${OBFUSCATOR_CONFIG}" 2>/dev/null | awk '{print $3}' | sed 's/:.*//')

  if [ -n "${server_ip}" ]; then
    if ping -c 1 -W 3 "${server_ip}" >/dev/null 2>&1; then
      print_status "OK" "Сервер доступен: ${server_ip}"
    else
      print_status "WARN" "Сервер недоступен: ${server_ip}"
    fi
  fi
}

echo "=========================================="
echo "  Phobos Router Health Check"
echo "=========================================="
echo ""
printf "Дата проверки: %s\n" "$(date '+%Y-%m-%d %H:%M:%S')"
echo ""

echo "==> Проверка файлов конфигурации"
check_config_files

echo ""
echo "==> Проверка init скрипта"
check_init_script

echo ""
echo "==> Проверка процесса wg-obfuscator"
check_obfuscator_process
check_obfuscator_listening

echo ""
echo "==> Проверка WireGuard в Keenetic"
check_wireguard_keenetic

echo ""
echo "==> Проверка сетевого подключения"
check_dns_resolution
check_internet_via_tunnel

echo ""
echo "==> Системная информация"
echo "  Архитектура: $(uname -m)"
echo "  Uptime: $(uptime 2>/dev/null | sed 's/.*up *//' | sed 's/, *[0-9]* users.*//' | sed 's/, *load average.*//')"
echo "  Load average: $(uptime 2>/dev/null | sed 's/.*load average: *//' 2>/dev/null || echo 'N/A')"

echo ""
echo "=========================================="
echo "  Проверка завершена"
echo "=========================================="
echo ""
