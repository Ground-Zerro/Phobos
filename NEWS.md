# История изменений Phobos

## Таблица изменений

| Дата | Что сделано | Почему (причина, проблема) |
|------|-------------|----------------------------|
| **2025-12-10** | Улучшен health-check.sh для Linux клиентов | Исправлено определение статуса интерфейса (up если handshake < 180 сек), проверка VPS использует ping с указанием интерфейса (-I), системная информация не блокируется ошибками DNS |
| 2025-12-10 | "Мониторинг клиентов" перенесен в субменю "Управление клиентами" | Логичнее размещение - мониторинг является частью управления клиентами, теперь доступен как 4-й пункт субменю |
| 2025-12-10 | Исправлена проверка UFW на Linux клиенте | Linux клиент использует исходящие соединения и локальный интерфейс (127.0.0.1), открытие портов в UFW не требуется |
| 2025-12-10 | VPN на Linux клиенте настроен как запасной интерфейс | Туннель работает, но не перехватывает системный трафик автоматически (Table = off, маршрут только к 10.25.0.0/16) |
| **2025-12-09** | Добавлена поддержка устройств Netcraze | Netcraze - это устройства Keenetic под другой торговой маркой, теперь определяются |
| 2025-12-09 | Изменен порядок пунктов главного меню Phobos | Управление клиентами перенесено на первое место, как наиболее используемая функция |
| 2025-12-09 | Настройка WG-Obfuscator вынесена в главное меню (3-й пункт) | Быстрый доступ к настройкам обфускатора без захода в системное меню |
| 2025-12-09 | Добавлена смена внутреннего пула адресов WireGuard | Возможность изменения туннельной подсети (IPv4/IPv6) с автоматическим перезапуском WireGuard и предупреждением о необходимости перегенерации клиентских конфигураций |
| 2025-12-09 | Автоматическое добавление портов Phobos в UFW при установке | Упрощение установки на VPS с UFW - автоматически добавляются порты WireGuard, Obfuscator и HTTP в исключения файрволла |
| 2025-12-09 | Добавлена поддержка Linux клиентов (Ubuntu/Debian) | Phobos теперь можно развернуть не только на роутерах, но и на Linux компьютерах как клиент |
| **2025-11-29** | Многопоточная обработка пакетов wg-obfuscator | Повышение производительности на многоядерных системах + увеличение пропускной способности |
| **2025-11-25** | Проверка и добавление MASQUERADE правил для IPv4 и IPv6 | Установка Phobos сервера скриптом не проверяла наличие правил MASQUERADE для IPv4 и IPv6 |
| 2025-11-25 | Исправление проверки WireGuard в health check | Health check тестировал WireGuard на прямом порту вместо проверки интерфейса |
| **2025-11-20** | Принудительная установка curl и jq в install-router.sh.template | Скрипт только предупреждал об отсутствии зависимостей, но не устанавливал их автоматически |
| 2025-11-20 | Автоматическая установка jq в vps-generate-install-command.sh | Скрипт падал при отсутствии jq |
| 2025-11-20 | Изменена логика выбора IP адресов на "первый свободный" | Старая логика "последний +1" не использовала освободившиеся адреса после удаления клиентов, приводила к быстрому исчерпанию адресного пространства |
| 2025-11-20 | Поиск свободных IP через metadata.json и WireGuard конфигурацию | Дублирование IP адресов из-за ненадежной проверки только по WireGuard конфигурации |
| 2025-11-20 | Добавлена дата создания конфигурации в список клиентов | Отсутствовала информация о времени создания клиентов в меню phobos |
| 2025-11-20 | Статическая линковка для x86_64 сборок wg-obfuscator | Ошибка GLIBC_2.34 not found на Ubuntu 20.04 - бинарник требовал новую версию glibc |
| 2025-11-20 | Добавлен атрибут target для AVX2 функций в obfuscation.h | Ошибка компиляции при отсутствии глобального флага -mavx2, runtime проверка CPU |
| 2025-11-20 | Автоматическая установка кросскомпиляторов в build-all-architectures.sh | Убран интерактивный запрос для автоматизации CI/CD сборок |
| 2025-11-20 | Добавлен libc6-dev в зависимости для статической компиляции | Необходим для полной статической линковки на Debian/Ubuntu системах |
| **2025-11-12** | Расширена подсеть WireGuard с 10.8.0.0/24 на 10.25.0.0/16 | Поддержка до 65534 клиентов вместо 254, масштабирование для больших развертываний |
| 2025-11-12 | Реализована автоматическая выдача IP с двумя октетами (10.25.X.Y) | Распределение IP адресов в расширенной подсети /16 |
| 2025-11-12 | Изменена подсеть IPv6 с fd00:10:8::/64 на fd00:10:25::/48 | Соответствие новой схеме адресации IPv4, единообразие нумерации |
| 2025-11-12 | IPv6 адреса клиентов формируются как fd00:10:25::{hex} | Прямое соответствие между IPv4 и IPv6 адресами клиентов |
| 2025-11-12 | Срок действия токенов по умолчанию сокращен с 24 до 1 часа | Безопасность - минимизация времени жизни установочных ссылок |
| 2025-11-12 | TOKEN_TTL=3600 добавлен в server.env | Конфигурируемый срок действия токенов через переменную окружения |
| 2025-11-12 | Реализована изоляция клиентов через iptables (wg0→wg0 DROP) | Безопасность - клиенты не могут взаимодействовать напрямую через VPN |
| 2025-11-12 | Очистка [Peer] блоков в wg0.conf через awk | Удаление пустых peer блоков, комментариев и лишних пустых строк |
| 2025-11-12 | Параметры маршрутизации Keenetic: priority, defaultgw | Корректная настройка приоритета и поведения маршрутизации WireGuard интерфейса на роутерах Keenetic |
| **2025-11-12** | Добавлена поддержка роутеров OpenWrt | Расширение поддерживаемых платформ - теперь Phobos работает не только на Keenetic |
| 2025-11-12 | Создан `router-configure-wireguard-openwrt.sh` | Автоматическая настройка WireGuard через UCI на OpenWrt роутерах |
| 2025-11-12 | Обновлен `install-router.sh` с автоопределением платформы | Универсальный установщик для Keenetic и OpenWrt - автоматический выбор метода настройки |
| 2025-11-12 | Архитектурная оптимизация wg-obfuscator (AVX2/NEON) | Повышение производительности обфускации на x86/ARM процессорах с SIMD инструкциями |
| 2025-11-12 | Добавлены бинарники wg-obfuscator для x86 и armv7 | Поддержка роутеров на x86 архитектуре и старых ARM устройств (armv7) |
| 2025-11-12 | Обновлен `vps-generate-package.sh` для OpenWrt | Генерация пакетов с конфигурацией для обеих платформ (Keenetic и OpenWrt) |
| 2025-11-12 | Обновлены `health-check.sh` и `phobos-uninstall.sh` | Поддержка проверки состояния и удаления на всех платформах |
| 2025-11-12 | Улучшен `detect-router-arch.sh` | Определение платформы OpenWrt/LEDE и выбор правильной директории установки |
| **2025-11-10** | Критический апдейт безопасности HTTP сервера | HTTP сервер показывал листинг директорий - любой мог получить доступ к полным архивам пакетов и токенам через браузер |
| 2025-11-10 | Создан безопасный `phobos-http-server.py` | Блокирует листинг директорий, отдает файлы только по прямым ссылкам, защита от path traversal |
| 2025-11-10 | Обновлен `vps-start-http-server.sh` | Интеграция безопасного HTTP сервера вместо стандартного `python3 -m http.server` |
| **2025-11-09** | Обновлена документация (README.md, docs/) | Отражение всех изменений в проекте, удаление устаревшей информации |
| 2025-11-09 | Добавлена проверка внешнего IP для активных WireGuard туннелей | Health check не показывал реальный внешний IP туннелей - невозможно было проверить что туннель действительно работает |
| 2025-11-09 | Исправлен парсинг JSON с jq во всех скриптах роутера | Некорректная работа с JSON через grep/cut приводила к ошибкам при поиске и удалении интерфейсов |
| 2025-11-09 | Добавлена автоматическая установка jq на роутере | jq необходим для корректного парсинга JSON от RCI API роутера Keenetic |
| 2025-11-09 | Исправлен `router-configure-wireguard.sh` | Скрипт не находил созданный интерфейс "Phobos-XXX" из-за некорректного парсинга JSON |
| 2025-11-09 | Создан `phobos-uninstall.sh` с поддержкой jq | Автоматическое удаление всех компонентов Phobos через RCI API |
| 2025-11-09 | Обновлен `health-check.sh` | Использование jq для проверки WireGuard интерфейсов, отображение внешних IP |
| 2025-11-09 | Увеличена пауза перед проверкой интерфейса (2→5 сек) | Система не успевала применить конфигурацию WireGuard |
| 2025-11-09 | Интеллектуальная генерация портов (100-700) | Старый диапазон 10000-60000 мог конфликтовать с другими сервисами |
| 2025-11-09 | Функция `generate_safe_port()` с исключениями | Автоматическое исключение IANA зарезервированных портов, часто используемых портов, занятых портов |
| 2025-11-09 | Автоматическое определение IPv6 с двойной проверкой | Ненадежное определение IPv6 через один сервис давало ложные результаты |
| 2025-11-09 | Два независимых метода проверки IPv6 с перекрестной валидацией | Гарантирует достоверность определения публичного IPv6 адреса |
| 2025-11-09 | Удалены ненужные зависимости (build-essential, git, make, gcc, g++) | Уменьшение размера установки, ускорение развертывания - компиляция не требуется |
| 2025-11-09 | Добавлена остановка сервисов перед переустановкой | Конфликты при обновлении из-за запущенных процессов |
| 2025-11-09 | `vps-wg-setup.sh` - остановка WireGuard перед настройкой | Избежание ошибок при переконфигурации |
| 2025-11-09 | `vps-obfuscator-setup.sh` - остановка obfuscator перед установкой | Избежание конфликтов портов |
| 2025-11-09 | `vps-start-http-server.sh` - остановка HTTP сервера | Корректное обновление конфигурации |
| 2025-11-09 | `install-router.sh` - остановка wg-obfuscator перед установкой | Избежание ошибок при переустановке на роутере |
| 2025-11-09 | Развертывание скрипта `phobos-uninstall.sh` при установке | Удобное удаление Phobos без ручных команд |
