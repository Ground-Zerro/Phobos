# Уровни логирования (Log Levels)

## Описание

Система логирования Phobos Bot поддерживает несколько уровней детализации логов. Уровень логирования определяет, какие события будут записываться в базу данных и системные журналы.

## Доступные уровни

### TRACE
**Самый детальный уровень логирования**

- Записывает все возможные события, включая трассировку выполнения кода
- Используется для глубокой отладки и анализа поведения системы
- Создает очень большой объем логов
- **Рекомендуется**: только для разработки и глубокого анализа проблем
- **Не рекомендуется**: для production окружения из-за высокой нагрузки

**Примеры событий:**
- Вызовы всех функций
- Значения переменных на каждом шаге
- Детальная трассировка выполнения скриптов

### DEBUG
**Детальное логирование для отладки**

- Записывает отладочную информацию о работе системы
- Включает детали выполнения команд, SQL-запросов, вызовов API
- Помогает диагностировать проблемы в работе бота
- **Рекомендуется**: для тестовых окружений и troubleshooting
- **Используйте осторожно**: в production из-за увеличенного объема логов

**Примеры событий:**
- Параметры входящих команд
- Результаты SQL-запросов
- Детали взаимодействия с Telegram API
- Промежуточные результаты обработки

### INFO
**Стандартный уровень логирования (по умолчанию)**

- Записывает информационные события о нормальной работе системы
- Включает успешные операции, старт/стоп сервисов, основные действия пользователей
- Оптимальный баланс между информативностью и объемом логов
- **Рекомендуется**: для production окружения
- Позволяет отслеживать работу системы без излишней детализации

**Примеры событий:**
- Выполнение команд пользователями (/start, /create, /delete)
- Создание/удаление конфигураций
- Регистрация новых пользователей
- Старт/остановка сервисов (watchdog, backup, config reloader)
- Создание резервных копий

### WARNING
**Предупреждения о потенциальных проблемах**

- Записывает события, которые могут указывать на проблемы, но не критичны
- Система продолжает работать нормально
- Требует внимания администратора
- **Рекомендуется**: всегда включено в production

**Примеры событий:**
- Превышение лимитов (rate limiting)
- Попытки доступа заблокированных пользователей
- Неудачные попытки выполнения операций с повторной попыткой
- Проблемы с внешними ресурсами (временная недоступность)
- Устаревшие конфигурации

### ERROR
**Ошибки в работе системы**

- Записывает ошибки, которые привели к сбою операции
- Операция не выполнена, но система продолжает работать
- Требует оперативного внимания администратора
- **Рекомендуется**: всегда включено

**Примеры событий:**
- Ошибки выполнения скриптов
- Ошибки базы данных
- Ошибки отправки сообщений через Telegram API
- Ошибки создания/удаления конфигураций
- Недоступность критических ресурсов

### CRITICAL (не используется в текущей версии)
**Критические ошибки**

- Зарезервирован для критических сбоев системы
- События, которые могут привести к остановке бота
- Требует немедленного вмешательства

**Примеры событий (теоретические):**
- Невозможность подключения к базе данных
- Критическая ошибка памяти
- Сбой основных компонентов системы

### NONE
**Минимальное логирование**

- Логирование практически отключено
- Записываются только критические события
- **Не рекомендуется**: даже для production, так как затрудняет диагностику

## Настройка уровня логирования

### Через базу данных

```sql
UPDATE configuration
SET config_value = 'DEBUG'
WHERE config_key = 'log_level';
```

### Через команду /config (для администраторов)

```
/config log_level INFO
```

## Иерархия логирования

Каждый уровень включает в себя все уровни выше:

```
TRACE → включает все события
  ↓
DEBUG → включает DEBUG, INFO, WARNING, ERROR
  ↓
INFO → включает INFO, WARNING, ERROR (рекомендуется по умолчанию)
  ↓
WARNING → включает WARNING, ERROR
  ↓
ERROR → включает только ERROR
  ↓
NONE → минимальное логирование
```

## Рекомендации по использованию

### Production окружение
```
log_level = INFO
```
- Оптимальный баланс
- Достаточно информации для мониторинга
- Умеренный объем логов

### Staging/Testing окружение
```
log_level = DEBUG
```
- Детальная информация для тестирования
- Помогает выявить проблемы до production

### Troubleshooting
```
log_level = TRACE
```
- Временно установить для диагностики
- Вернуть к INFO после решения проблемы

### Минимальное логирование (не рекомендуется)
```
log_level = WARNING
```
- Используйте только при критической нехватке места
- Затрудняет диагностику проблем

## Мониторинг и анализ логов

### Просмотр логов через команды бота

```bash
# Системные логи
sudo journalctl -u phobos-bot -n 100 --no-pager

# Логи конкретного пользователя (через команду /logs)
/logs
```

### Фильтрация по уровню в базе данных

```sql
-- Все ошибки
SELECT * FROM logs WHERE log_level = 'ERROR' ORDER BY timestamp DESC LIMIT 50;

-- Все предупреждения и ошибки
SELECT * FROM logs WHERE log_level IN ('WARNING', 'ERROR') ORDER BY timestamp DESC;

-- События за последний час
SELECT * FROM logs
WHERE timestamp > datetime('now', '-1 hour')
ORDER BY timestamp DESC;
```

## Влияние на производительность

| Уровень | Объем логов | Нагрузка на БД | Производительность |
|---------|-------------|----------------|-------------------|
| TRACE   | Очень высокий | Очень высокая | Значительное снижение |
| DEBUG   | Высокий | Высокая | Умеренное снижение |
| INFO    | Средний | Средняя | Минимальное влияние |
| WARNING | Низкий | Низкая | Нет влияния |
| ERROR   | Очень низкий | Очень низкая | Нет влияния |

## Очистка старых логов

Рекомендуется периодически очищать старые логи для освобождения места:

```bash
# Через команду бота (администраторы)
/cleanuplogs 30  # Удалить логи старше 30 дней
```

## Примеры использования

### Отладка проблемы с командой /create

1. Установить уровень DEBUG:
```
/config log_level DEBUG
```

2. Воспроизвести проблему

3. Проверить логи:
```sql
SELECT * FROM logs
WHERE command LIKE '%create%'
AND timestamp > datetime('now', '-1 hour')
ORDER BY timestamp DESC;
```

4. Вернуть уровень INFO:
```
/config log_level INFO
```

### Мониторинг ошибок в production

```sql
-- Сколько ошибок за последние 24 часа
SELECT COUNT(*) FROM logs
WHERE log_level = 'ERROR'
AND timestamp > datetime('now', '-1 day');

-- Топ команд с ошибками
SELECT command, COUNT(*) as error_count
FROM logs
WHERE log_level = 'ERROR'
AND timestamp > datetime('now', '-7 day')
GROUP BY command
ORDER BY error_count DESC;
```
