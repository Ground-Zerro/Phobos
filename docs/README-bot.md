# Phobos Bot - Руководство по Telegram-боту

## Содержание

- [Введение](#введение)
- [Установка и настройка](#установка-и-настройка)
- [Команды бота](#команды-бота)
- [Система уровней пользователей](#система-уровней-пользователей)
- [Автоматизация](#автоматизация)
- [Управление ботом](#управление-ботом)
- [Конфигурация](#конфигурация)

## Введение

Phobos Bot — Telegram-бот для управления клиентами VPN. Написан на Go с использованием SQLite для хранения данных.

### Статус проекта

> **Важно:** Бот имеет полностью работающий функционал, но **не является законченным продуктом**. Это гибкая основа, которую легко можно доработать под свои нужды:
> - Добавить новые команды
> - Изменить логику работы
> - Интегрировать с другими системами
> - Настроить шаблоны сообщений
> - Расширить систему уровней пользователей
>
> Бот разработан с расчетом на модификацию и расширение функционала.

### Основные возможности

- Создание и удаление клиентов через Telegram
- Просмотр статистики и мониторинг подключений
- Система уровней пользователей (basic, premium, moderator, admin)
- Автоматический watchdog для удаления неактивных клиентов
- Обратная связь и поддержка
- Health check endpoint (HTTP)
- Автоматические бэкапы базы данных
- Горячая перезагрузка конфигурации

## Установка и настройка

### Требования

- Go 1.21+ (для сборки)
- Ubuntu Server 20.04/22.04
- Установленный Phobos на VPS
- Telegram Bot Token (получить у @BotFather)

### Установка

1. Создайте директорию для бота:
```bash
mkdir -p /root/bot/phobos-bot
cd /root/bot/phobos-bot
```

2. Скопируйте файлы бота из репозитория:
```bash
cp -r /opt/Phobos/repo/bot/phobos-bot/* .
```

3. Создайте файл конфигурации:
```bash
cat > config.yaml << EOF
bot:
  database_path: "phobos-bot.db"
EOF
```

4. Соберите бота (опционально, если нет готового бинарника):
```bash
go build -o bot cmd/bot/main.go
```

5. Запустите бота:
```bash
sudo /root/bot/phobos-bot/bash/bot_toggle.sh
```

### Первоначальная настройка

**ВАЖНО:** База данных в репозитории очищена от персональных данных и содержит только структуру и шаблоны сообщений. См. `bot/phobos-bot/bash/DATABASE-CLEANUP-INFO.md` для подробностей.

После первого запуска бот использует существующую базу данных, но требует настройки следующих параметров:

1. **Bot Token** - токен от @BotFather (очищен перед публикацией)
2. **Scripts Directory** - путь к скриптам (`/opt/Phobos/repo/server/scripts`, очищен)
3. **Clients Directory** - путь к клиентам (`/opt/Phobos/clients`, очищен)
4. **WireGuard Interface** - интерфейс WireGuard (`wg0`)

Настройка через команду `/admin` → Config Management.

**Первый пользователь автоматически получит уровень admin.**

## Команды бота

### Команды для всех пользователей

- `/start` - Начало работы с ботом
- `/create` - Создать нового клиента
- `/stat` - Просмотр статистики подключений
- `/delete` - Удалить клиента
- `/info` - Информация о боте и системе
- `/selfhost` - Информация о самостоятельном хостинге
- `/premium` - Информация о премиум статусе
- `/help` - Справка по командам
- `/feedback` - Отправить обратную связь администраторам

### Команды для модераторов и администраторов

- `/admin` - Панель администратора (только для admin/moderator)
  - User Management - управление пользователями
  - System Management - управление системой
  - Feedback Management - управление обратной связью
  - Logs - просмотр логов
  - Config Management - управление конфигурацией (только admin)
  - Message Templates - управление шаблонами сообщений (только admin)

Подробнее см. [admin_moderator_commands.md](../bot/phobos-bot/docs/admin_moderator_commands.md).

## Система уровней пользователей

### Уровни доступа

1. **Basic** (базовый)
   - Создание клиентов (с ограничениями)
   - Просмотр статистики своих клиентов
   - Удаление клиентов
   - Обратная связь

2. **Premium** (премиум)
   - Все возможности Basic
   - Защита от автоматического удаления клиентов
   - Приоритетная поддержка
   - Возможность установки срока действия премиума

3. **Moderator** (модератор)
   - Все возможности Premium
   - Управление пользователями (изменение уровней)
   - Просмотр и ответы на обратную связь
   - Просмотр логов системы
   - Управление блок-листом

4. **Admin** (администратор)
   - Все возможности Moderator
   - Полный доступ к конфигурации системы
   - Управление шаблонами сообщений
   - Управление скриптами
   - Неограниченные права

Подробнее см. [user_levels.md](../bot/phobos-bot/docs/user_levels.md).

## Автоматизация

### Watchdog (Сторожевой таймер)

Автоматически удаляет неактивных клиентов по следующим критериям:

1. **Защищенные пользователи:**
   - Premium, Moderator, Admin - НЕ удаляются автоматически

2. **Незащищенные пользователи (Basic):**
   - Неактивны более `watchdog_inactive_threshold_minutes` (по умолчанию 60 минут)
   - Превысили `max_test_duration_minutes` с момента создания (по умолчанию 1440 минут / 24 часа)

3. **Маркер удаления:**
   - При удалении конфигурации клиента пользователь помечается специальным маркером
   - При восстановлении конфигурации маркер сбрасывается

Настройка параметров watchdog через `/admin` → Config Management.

### Config Reloader (Перезагрузка конфигурации)

Автоматически перезагружает конфигурацию бота каждые `config_reload_interval_minutes` (по умолчанию 5 минут). Позволяет изменять настройки через базу данных без перезапуска бота.

### Backup Service (Служба резервного копирования)

Автоматически создает резервные копии базы данных:

- **Интервал:** `backup_interval_hours` (по умолчанию 24 часа)
- **Хранение:** `backup_retention_days` (по умолчанию 7 дней)
- **Директория:** `backup_directory` (по умолчанию `/root/bot/phobos-bot/backups`)

Старые бэкапы автоматически удаляются.

### Health Server (Сервер здоровья)

HTTP сервер для мониторинга состояния бота:

- **Порт:** `health_server_port` (по умолчанию 8080)
- **Endpoint:** `http://localhost:8080/health`

Возвращает JSON с информацией о состоянии базы данных.

## Управление ботом

### Запуск и остановка

```bash
sudo /root/bot/phobos-bot/bash/bot_toggle.sh
```

Скрипт автоматически:
- Определяет состояние бота (запущен/остановлен)
- Переключает состояние (старт/стоп)
- Создает systemd service при первом запуске
- Показывает логи после запуска

### Просмотр статуса

```bash
sudo systemctl status phobos-bot
```

### Просмотр логов

```bash
sudo journalctl -u phobos-bot -f
```

Или последние 50 строк:
```bash
sudo journalctl -u phobos-bot -n 50 --no-pager
```

### Перезапуск

```bash
sudo systemctl restart phobos-bot
```

### Автозапуск

Бот автоматически включается в автозапуск при создании через `bot_toggle.sh`.

Ручное управление:
```bash
sudo systemctl enable phobos-bot   # Включить автозапуск
sudo systemctl disable phobos-bot  # Отключить автозапуск
```

## Конфигурация

### Файл конфигурации (config.yaml)

Минимальная конфигурация:
```yaml
bot:
  database_path: "phobos-bot.db"
```

Путь к конфигурации можно указать:
1. Флагом командной строки: `./bot -config /path/to/config.yaml`
2. Переменной окружения: `CONFIG_FILE_PATH=/path/to/config.yaml ./bot`
3. По умолчанию: `./config.yaml`

### База данных (phobos-bot.db)

Все остальные настройки хранятся в базе данных SQLite. Управление через `/admin` → Config Management.

**Основные параметры:**

- `bot_token` - токен Telegram бота
- `scripts_dir` - путь к скриптам Phobos
- `clients_dir` - путь к клиентам
- `wg_interface` - интерфейс WireGuard
- `script_timeout_seconds` - таймаут выполнения скриптов (120)
- `watchdog_enabled` - включить watchdog (true)
- `watchdog_check_interval_minutes` - интервал проверки (5)
- `watchdog_inactive_threshold_minutes` - порог неактивности (60)
- `max_test_duration_minutes` - максимальное время тестирования (1440)
- `restrict_new_users` - ограничить новых пользователей (false)
- `max_clients` - максимальное количество клиентов (100)
- `health_server_enabled` - включить health сервер (true)
- `health_server_port` - порт health сервера (8080)
- `backup_enabled` - включить бэкапы (true)
- `backup_interval_hours` - интервал бэкапов (24)
- `backup_retention_days` - хранение бэкапов (7)

### Шаблоны сообщений

Все сообщения бота настраиваются через базу данных. Управление через `/admin` → Message Templates.

Шаблоны поддерживают переменные в формате Go templates. Подробнее см. [MESSAGE_TEMPLATES.md](../bot/phobos-bot/docs/MESSAGE_TEMPLATES.md).

## База данных

### Очистка перед публикацией

База данных `phobos-bot.db` в репозитории очищена от всех персональных данных:
- Пользователи (261 записей) - удалены
- Логи (3170 записей) - удалены
- Обратная связь (21 запись) - удалена
- Чувствительные параметры конфигурации - очищены

Сохранены только:
- Структура базы данных
- Шаблоны сообщений (103 записи)
- Системные параметры конфигурации (22 записи)

Подробности в `bot/phobos-bot/bash/DATABASE-CLEANUP-INFO.md`.

### Инструменты очистки

В директории `bot/phobos-bot/bash/` доступны инструменты для очистки БД:
- **cleanup-db.py** - Python скрипт (рекомендуется)
- **cleanup-db.sql** - SQL скрипт
- **cleanup-db.sh** - Bash скрипт

**Использование:**
```bash
cd /root/bot/phobos-bot/bash
python3 cleanup-db.py
```

## Полезные ссылки

- [Документация Phobos](https://github.com/Ground-Zerro/Phobos)
- [Команды администраторов](../bot/phobos-bot/docs/admin_moderator_commands.md)
- [Система уровней](../bot/phobos-bot/docs/user_levels.md)
- [Шаблоны сообщений](../bot/phobos-bot/docs/MESSAGE_TEMPLATES.md)
- [Конфигурация](../bot/phobos-bot/docs/CONFIG.md)
- [Информация об очистке БД](../bot/phobos-bot/bash/DATABASE-CLEANUP-INFO.md)

## Расширение функционала

Бот разработан с расчетом на легкую модификацию:

### Архитектура

- **Модульная структура** - код разделен на логические модули (internal/)
- **Репозитории** - доступ к данным через интерфейсы
- **Шаблоны сообщений** - все тексты в БД, легко изменяются
- **Конфигурация в БД** - все настройки можно менять без перекомпиляции

### Как доработать

1. **Добавить новую команду:**
   - Добавить обработчик в `internal/handler.go`
   - Добавить шаблон сообщения в БД
   - Зарегистрировать команду в `cmd/bot/main.go`

2. **Изменить логику:**
   - Основная логика в `internal/bot.go`
   - Автоматизация в `internal/` (watchdog, backup, config_reloader)

3. **Добавить новый уровень пользователя:**
   - Обновить `UserLevel` в `internal/bot.go`
   - Добавить проверки прав в `internal/handler.go`

4. **Изменить тексты:**
   - Через `/admin` → Message Templates
   - Или напрямую в БД (таблица `message_templates`)

5. **Интеграция с другими системами:**
   - Добавить новые репозитории в `internal/database/`
   - Расширить `ScriptRunner` для вызова внешних скриптов

### Примеры доработок

- Интеграция с платежными системами (для премиум)
- Автоматическая отправка уведомлений
- Статистика использования
- Ограничение трафика
- Интеграция с monitoring системами

## Поддержка

По вопросам обращайтесь:
- GitHub Issues: https://github.com/Ground-Zerro/Phobos/issues
- Через бота: команда `/feedback`
